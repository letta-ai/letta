name: Self-Hosted Provider Integration - Ollama

on:
  workflow_dispatch:
    # inputs:
    #   ref:
    #     description: 'Git ref to test'
    #     required: false
    #     type: string
    #     default: ${{ github.sha || github.ref || github.event.pull_request.head.sha }}
  pull_request:
    paths:
      - 'apps/core/**'
      - '.github/workflows/test-ollama.yml'
      - '.github/workflows/reusable-test-workflow.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  test-ollama:
    uses: ./.github/workflows/reusable-test-workflow.yml
    with:
      test-type: "integration"
      install-args: "-E dev -E postgres -E external-tools -E tests -E cloud-tool-sandbox -E google"
      test-command: "poetry run pytest -svv tests/"
      timeout-minutes: 60
      runner: '["self-hosted", "gpu", "ollama"]'
      matrix-strategy: |
        {
          "fail-fast": false,
          "matrix": {
            "test_suite": [
              "test_providers.py::test_ollama",
              "integration_test_send_message.py",
              "test_ollama.py"
            ]
          }
        }
    secrets: inherit
