name: Sync With OSS

permissions:
  contents: write
  pull-requests: write

on:
  # 1) Triggered by a local push that touches files under apps/core/**
  push:
    branches: [ main ]
    paths:
      - 'apps/core/**'

  # 2) Triggered by a repository_dispatch from the OSS repo
  repository_dispatch:
    types: [oss-update]

  # 3) Manual trigger from GitHub web interface
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.SYNC_PAT }}

    steps:
      - name: Check out private repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT }}

      - name: Configure Git
        run: |
          git config user.name "Letta Sync Bot"
          git config user.email "bot@users.noreply.github.com"

      - name: Install Just
        uses: extractions/setup-just@v2

      - name: Determine sync direction
        id: determine
        run: |
          echo "event_name=${{ github.event_name }}" >> $GITHUB_OUTPUT

      - name: Push to OSS if push event
        if: ${{ steps.determine.outputs.event_name == 'push' }}
        run: |
          # TODO: switch from sync to main branch once finished testing
          just push-core-to-oss sync

      - name: Pull from OSS + open PR if dispatch or manual
        if: ${{ steps.determine.outputs.event_name == 'repository_dispatch' || steps.determine.outputs.event_name == 'workflow_dispatch' }}
        run: |
          # Pull from OSS
          just pull-oss-to-core

          # Attempt to generate PR immediately.
          # If there's a conflict that wasn't auto-committed, it will fail here.
          just generate-integration-pr

      # Optional Slack notification on failure
      - name: Notify Slack on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"Sync job failed. Likely a merge conflict. Please run `just pull-oss-to-core`, resolve conflicts, and `just generate-integration-pr` manually."}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
