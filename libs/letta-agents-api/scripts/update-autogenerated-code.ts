import { Project, SyntaxKind } from 'ts-morph';
import * as path from 'path';

async function job() {
  const project = new Project();

  project.addSourceFilesAtPaths(
    path.join(
      __dirname,
      '..',
      'src',
      'lib',
      '_autogenerated',
      'requests',
      '**/*.ts'
    )
  );

  const typesFile = project.getSourceFileOrThrow('types.gen.ts');

  // find type name 'object' and delete it
  typesFile.getTypeAliasOrThrow('object').remove();

  const openAPIFile = project.getSourceFileOrThrow(
    path.join(
      __dirname,
      '..',
      'src',
      'lib',
      '_autogenerated',
      'requests',
      'core',
      'OpenAPI.ts'
    )
  );

  // find the constant OpenAPI, look at BASE property and change it to process.env.LETTA_AGENTS_ENDPOINT

  const openAPI = openAPIFile.getVariableDeclarationOrThrow('OpenAPI');

  const dataValue = openAPI.getInitializerIfKind(
    SyntaxKind.ObjectLiteralExpression
  );

  dataValue?.getProperty('BASE')?.remove();

  dataValue?.addPropertyAssignment({
    name: 'BASE',
    initializer: "process.env.LETTA_AGENTS_ENDPOINT || ''",
  });

  const sourceFile = project.getSourceFileOrThrow('services.gen.ts');

  sourceFile.getClasses().forEach((cls) => {
    cls.getMethods().forEach((method) => {
      const hasHeaderParam = method.getParameters().some((param) => {
        return param.getName() === 'headers';
      });

      if (!hasHeaderParam) {
        method.addParameter({
          name: 'headers',
          type: '{ user_id: string }',
          hasQuestionToken: true,
        });
      }

      method.forEachChild((node) => {
        if (node.isKind(SyntaxKind.Block)) {
          node.forEachChild((child) => {
            if (child.isKind(SyntaxKind.ReturnStatement)) {
              child.forEachChild((sub) => {
                if (sub.isKind(SyntaxKind.CallExpression)) {
                  const secondPart = sub.getArguments()[1];

                  if (secondPart.isKind(SyntaxKind.ObjectLiteralExpression)) {
                    secondPart.getProperty('headers')?.remove();

                    secondPart.addShorthandPropertyAssignment({
                      name: 'headers',
                    });
                  }
                }
              });
            }
          });
        }
      });
    });
  });

  await project.save();
}

job().catch(console.error);
